# Quick Start Guide

## Pre-requisites

A modern Linux system with a running Docker, `docker-compose`, GNU `make` and `git`.
Some testing has been done on `podman` but it is known to have issues.

## Starting Services and Initial Import

Run `make` from the top directory. This will bring up a Docker stack with an app server
listening on <http://127.0.0.1:8000>.
The stack will be running in the foreground. For a background run, use `make bg` command,
and when done with it, bring it down with `make dc-down`.

### Initial Import via Admin UI

Open the URL above, click the *Admin* link, login as `admin` with password `admin`, then go to any fact model page
(like *Posts* or *Comments*) and press [IMPORT FROM JPH](#) button.
This will start a foreground import job.
When the import is finished, you will see some records imported from the fake API.

### Initial Import via Command Line

The initial import can alternatively be run from command line in a separate shell this way:

`make import`

## Replication

The system is configured by default to start a full replication (push) job of recently modified records
to the JSON Placeholder API every 10 minutes.
It also supports manual starting of full and partial replication.

### Full Periodic Push

The system is configured by default to start a full replication (push) job of recently modified records
to the JSON Placeholder API every 10 minutes. The job is started in background, using Celery async task queue.

After 10 minutes or so you will notice a record in the *SyncLog* model indicating that the initial push
has completed. In case all components are functioning properly, the records will have `success` flag set
and `end date` field filled in. The count field should indicate around 600 records, because the initial sync
pushes all records to the slave system.

If you modify at least one of the fact records (*Post*, *Comment*) and save them, the changes will be pushed
at the next run of the replication job.
Some 10 minutes later you will notice another `SyncLog`
record, with `count` field equal to the number of records you've modified.

### Full Manual Push

You can also start the push task manually by running it as an admin action.
This can be done by opening *Periodic Tasks* page in the admin, then ticking
the checkbox next to the *Full push to JSON Placeholder API* task, selecting *Run selected tasks* from the
*Action* dropdown above the task list, and pressing the [Go](#) button next to the dropdown.

### Partial Push of Selected Records

Fact models (*Posts*, *Comments*) also provide an ability to push a number of manually selected records via an admin action.
In order to do that, open the list of desired fact objects in the admin, tick checkboxes next to the records
you wish to push, select *Push selected records to JSON Placeholder API* from the *Action* dropdown above, and press
the [Go](#) button next to the dropdown.

Partial push action is performed in the foreground, and the UI will be blocked until it is complete.


## RESTful API

The system also acts as a RESTful API server exposing endpoints for accessing and manipulating data.

A built-in documentation and API browsing system should be available at <http://0.0.0.0:8000/blog/>

The API accepts regular session authentication with username/password as well as bearer token authentication.

### Bearer Token Authentication

Token can be generated via the admin interface by opening the *Tokens* model page, and pressing [ADD TOKEN](#).
The user ID on the next page needs to be filled in manually. You can use value `1` for the default superuser
created during system initialization.

Once the token object is saved, you will see a hexadecimal string generated by the system as its `KEY` value.
That string can be used in the `Authorization` header in order to access the API endpoints as the corresponding user.

The token can also be generated via a management command that can be run inside Docker stack this way:

`make cmd cmd='drf_create_token admin'`

The token authentication can be tested on command line by issuing the following `curl` command:

```sh
    curl -H 'Authorization: Bearer <TOKEN>' http://localhost:8000/blog/post/1/
```

where `<TOKEN>` should be substituted with the key obtained before.
If successful, that command should output a JSON record similar to the one below:

```json
    {"id":1,"created_date":"2024-02-28T19:25:48.727313Z","modified_date":"2024-02-28T19:25:48.727343Z","user_id":1,"title":"sunt aut facere repellat provident occaecati excepturi optio reprehenderit","body":"quia et suscipit\nsuscipit recusandae consequuntur expedita et cum\nreprehenderit molestiae ut ut quas totam\nnostrum rerum est autem sunt rem eveniet architecto"}    
```
